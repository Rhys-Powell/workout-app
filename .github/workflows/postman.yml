name: Automated API tests using Newman CLI

on:
  push:
    branches:
      - master
    paths:   
    - 'Workout.Api/**/*'

services:
  mysql:
    image: mysql:8.0.39 
    ports:
      - ${{ env.DB_PORT }}:3306
    options: >-
        --health-cmd="mysqladmin ping --silent"
        --health-interval=10s
        --health-timeout=5s
        --health-retries=3
    health-checks: always  
  
  api:
    image: Workout.Api/Dockerfile:latest  
    ports:
      - 8080:8080
    options: >  
      --env ASPNETCORE_ENVIRONMENT=Development
      --health-cmd="curl http://localhost:${{ env.API_PORT }}/api/health || exit 1"
      --health-interval=10s
      --health-timeout=5s
      --health-retries=5

env:
  API_PORT: 8080
  DB_PORT: 3306

jobs:
  automated-api-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'

      - name: Install Newman
        run: npm install -g newman

      - name: Run Newman API tests
        run: >
          newman run postman/"Workout app - instructions in 'Overview' tab".postman_collection.json 
          --env-var "access_token_dev=${{ secrets.ACCESS_TOKEN_DEV }}"
          --environment postman/"Local development".postman_environment.json
          --global-var "base_url=http://api:${{ env.API_PORT }}"
        timeout-minutes: 10
