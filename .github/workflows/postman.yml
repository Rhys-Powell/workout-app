name: Automated API tests using Newman CLI

on:
  push:
    branches:
      - test-branch
    paths:   
    - 'Workout.Api/**/*'

jobs:
  automated-api-tests:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0.39 
        ports:
          - 3306:3306
        options: >-
            --health-cmd="mysqladmin ping --silent"
            --health-interval=10s
            --health-timeout=5s
            --health-retries=3
    
      api:
        image: workout.api:latest  
        ports:
          - 8080:8080
        options: >  
          --env ASPNETCORE_ENVIRONMENT=Development
          --health-cmd="curl http://localhost:8080/api/health || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker Image
        run: |
          docker build -t workout.api:latest -f Workout.Api/Dockerfile .


      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'

      - name: Install Newman
        run: npm install -g newman

      - name: Run Newman API tests
        run: >
          newman run postman/"Workout app - instructions in 'Overview' tab".postman_collection.json 
          --env-var "access_token_dev=${{ secrets.ACCESS_TOKEN_DEV }}"
          --environment postman/"Local development".postman_environment.json
          --global-var "base_url=http://localhost:8080"
        timeout-minutes: 10
